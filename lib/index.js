const express=require('express'),request=require('request'),norm=require('normalize-url');let servers,sleep,msg,cur=0,argv=require('minimist')(process.argv.slice(2)),dev=argv.dev||argv.DEV;'local'===dev?(servers=[{url:'http://localhost:8081',key:''},'http://localhost:8081','http://localhost:8081'],sleep='http://localhost:8081',msg={head:'Bem vindo ao  Middleware BTM!',body:'Middleware escalonador e balanceador de carga para a API da aplica\xE7\xE3o.',action:'running  in '}):(dev==null?(sleep={key:'2a0a9c98-f4ac-472e-8863-38e0d4aa46cd',maintenance:!0,name:'btm-api0',stack_id:'',url:'https://btm-api0.herokuapp.com'},msg={action:'running in '}):(sleep={key:'2a0a9c98-f4ac-472e-8863-38e0d4aa46cd',maintenance:!0,name:'btm-api0',stack_id:'',url:'https://btm-api0.herokuapp.com',heroku:'https://api.heroku.com/apps/btm-api0'},msg={head:'Bem vindo ao  Middleware BTM!',body:'Middleware escalonador e balanceador de carga para a API da aplica\xE7\xE3o.',action:'running  in '}),servers=[{key:'402c7c2f-1a91-4f0a-ac20-f10a086fca21',maintenance:!0,name:'btm-api1',stack_id:'',url:'https://btm-api1.herokuapp.com',heroku:'https://api.heroku.com/apps/btm-api1'},{key:'f766902b-2d81-472f-b3f8-d86c59fac52c',maintenance:!0,name:'btm-api2',stack_id:'',url:'https://btm-api2.herokuapp.com',heroku:'https://api.heroku.com/apps/btm-api2'},{key:'f484ddae-8a44-423b-af45-3f7e4ce1ab9c',maintenance:!0,name:'btm-api3',stack_id:'',url:'https://btm-api3.herokuapp.com',heroku:'https://api.heroku.com/apps/btm-api3'}]);let token;const handler=(a,b)=>{try{a.headers.tk=token,a.pipe(request({url:norm(servers[cur].url+a.url)})).pipe(b),cur=(cur+1)%servers.length}catch(a){setTimeout((a,b)=>{handler(a,b)},2e3)}};let net=require('net');const server=express();server.use(async(a,b,c)=>{b.header('Access-Control-Allow-Origin','*'),b.header('Access-Control-Allow-Headers','Origin, X-Requested-With, Content-Type, Accept, Authorization '),b.header('Access-Control-Allow-Methods','GET, PATCH, POST, DELETE, OPTIONS'),b.header('Content-Type',' application/json; charset=utf-8'),b.header('X-Powered-By','btm-api'),'OPTIONS'===a.method?b.send():c()}).all('*',handler);let{isFreePort}=require('node-port-check'),{nextAvailable}=require('node-port-check');const getport=(a=8080)=>process.env.PORT||a,chalk=require('chalk'),run=async(a=8080)=>{try{let b=await getport(a);console.log(b),server.listen(b,b=>{b?run(a++):(console.clear(),console.log('Server Run in '+getport(a)))}),process.on('uncaughtException',()=>{console.clear(),console.log('eeee')})}catch(a){console.log(a)}},k=async()=>{console.log({get:await getport()})},mongoose=require('mongoose');mongoose.connect('mongodb://root:mkdirbuild0099@ds018708.mlab.com:18708/middleware').then(()=>{const a=new mongoose.Schema({tk:{type:String,require:!0}}),b=require('os'),c=mongoose.model('Tk',a);c.findOne({_id:'5b35aef9856afb46f98297fa'},(a,c)=>{console.log(c),token=c.tk,nextAvailable(getport(),'0.0.0.0').then(a=>{servers.map(a=>{request.get({url:a.heroku,headers:{Authorization:'Bearer '+a.key,Accept:'application/vnd.heroku+json; version=3'}},(b,c,d)=>{d=JSON.parse(c.body),a.stack_id=d.build_stack.id,request.patch({url:a.heroku,headers:{Authorization:'Bearer '+a.key,Accept:'application/vnd.heroku+json; version=3'},form:{build_stack:a.stack_id,maintenance:!1,name:a.name}},(a,b)=>{JSON.parse(b.body)})})}),server.listen(a,c=>{if(!c){console.clear();let c=Object.entries(b.networkInterfaces()),d='';for(let b=0;b<c.length;b++)d+='http://'+c[b][1][0].address+':'+a,b<c.length-1&&(d+=', ');msg.head?(console.log('\t\t'+chalk.red(msg.head)),console.log('\t'+chalk.blue(msg.body)),console.log('\t'+msg.action+' '+d)):console.log('\t'+msg.action+' '+d)}else console.log(c)})})})});const https=require('https');setInterval(()=>{request(servers[0].url,()=>{}),request(servers[1].url,()=>{}),request(servers[2].url,()=>{})},25e4),setInterval(()=>{let a,b;request.get({url:sleep.heroku,headers:{Authorization:'Bearer '+sleep.key,Accept:'application/vnd.heroku+json; version=3'}},(c,d,e)=>{e=JSON.parse(d.body),a=e.build_stack.id,b=e.name,sleep.stack_id=a,request.patch({url:sleep.heroku,headers:{Authorization:'Bearer '+sleep.key,Accept:'application/vnd.heroku+json; version=3'},form:{build_stack:a,maintenance:!1,name:b}},(a,b)=>{JSON.parse(b.body);let c=servers.filter(a=>a!==servers[0]);c.push(sleep),sleep=servers[0],servers=c,request.get({url:sleep.heroku,headers:{Authorization:'Bearer '+sleep.key,Accept:'application/vnd.heroku+json; version=3'}},(a,b,c)=>{c=JSON.parse(b.body),sleep.stack_id=c.build_stack.id,request.patch({url:sleep.heroku,headers:{Authorization:'Bearer '+sleep.key,Accept:'application/vnd.heroku+json; version=3'},form:{build_stack:sleep.stack_id,maintenance:!1,name:sleep.name}},(a,b)=>{JSON.parse(b.body)})})})})},288e5);let teste=()=>{let a=['a','b','c'],b='d',c=()=>{let c=a.filter(b=>b!==a[0]),d=0;return c.push(b),b=a[0],a=c,console.log(a,b),d++,!(10>d)||void setInterval(()=>{let c=a.filter(b=>b!==a[0]);c.push(b),b=a[0],a=c,console.log(a,b),d++},288e5)};c()};